# Session Log: 2026-02-17 — COBOL Doom Implementation

## What Was Done

Built a complete pseudo-3D first-person shooter in pure GnuCOBOL (994 lines, single file `doom.cob`). The game runs in a 120x40 terminal with ASCII raycasting, ANSI colors, enemies, shooting, and win/lose conditions.

### Brainstorming Phase
- Explored approaches: pure COBOL vs COBOL+C vs shell rendering
- User chose: pure GnuCOBOL with ASCII raycasting, walk+shoot gameplay, hardcoded map, 120x40 terminal, ANSI colors, moving enemies
- Design doc approved and saved: `docs/plans/2026-02-17-cobol-doom-design.md`

### Implementation (12 tasks, subagent-driven development)

| Task | Description | Commit |
|------|-------------|--------|
| 1 | Install GnuCOBOL + hello world scaffold | `c6cc35e` |
| 2 | ANSI escape code support (colors, cursor) | `f21eb30` |
| 3 | Single-key input via `stty raw` + `getchar` | `a1c24d2` |
| 4 | Trig lookup tables (FUNCTION SIN/COS intrinsics) | `45e0346` |
| 5 | 16x16 map data + player state | `2e4b0ae` |
| 6 | DDA raycasting engine with fisheye correction | `d8e78ea` |
| 7 | Frame buffer rendering with ASCII wall shading | `8fc9036` |
| 8 | Player movement (WASD) + wall collision | `1152f33` |
| 9 | ANSI color rendering (distance-based shading) | `88094a1` |
| 10 | Enemy spawning + depth-checked projection | `c9cbd0d` |
| 11 | Enemy chase AI + hitscan shooting + damage | `6b6b0c4` |
| 12 | HUD display + win/lose conditions + end screen | `1403e94` |

### Key Technical Decisions
- **FUNCTION SIN/COS intrinsics** instead of hardcoded trig tables — GnuCOBOL supports them natively, tables computed at runtime
- **`CALL "getchar"`** for input — `ACCEPT FROM CONSOLE` didn't work in raw mode
- **Parallel color buffer** — separate `WS-COLOR-BUF` tracks color per cell, ANSI codes inserted during output with color change tracking to minimize escape sequences
- **Manual ATAN2** — COBOL only has ATAN, quadrant correction done manually for enemy angle calculation
- **Independent X/Y collision** — player movement checks each axis separately for wall sliding

### Problems Solved
- `ACCEPT FROM CONSOLE` in raw mode created infinite loops → switched to C `getchar`
- Fixed-point truncation (sin(30) = 0.499999) → acceptable for raycasting precision
- Output buffer overflow risk with ANSI codes → increased `WS-OUTPUT-LINE` to `PIC X(1200)`

## Game Features
- DDA raycasting (120 rays/frame, max 64 steps/ray)
- ANSI color: blue ceiling, white/gray walls (distance-shaded), yellow floor, red enemies, green HUD, bright green exit
- Wall shading by distance: `@` → `#` → `=` → `-` → `.`
- Chase AI enemies (move toward player, attack within 1.5 cells)
- Hitscan shooting (5-degree hit cone, 25 damage)
- HUD: health, ammo, kills
- Win: reach exit cell (map value 9) / Lose: health reaches 0
- End screen with stats

## Final State
- **File**: `doom.cob` — 994 lines, compiles cleanly with `cobc -x -free doom.cob -o doom`
- **Binary**: 174KB
- **Status**: Complete, playable
- **Run**: `./doom` — WASD move/rotate, Space shoot, Q quit

## What's Next (if continuing)
- Multiple levels
- Different weapon types
- More enemy types
- Minimap overlay
- Sound (terminal bell for shots?)
- Difficulty settings
